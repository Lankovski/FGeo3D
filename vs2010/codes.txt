            if (pbhander == "GeoPolyline" && pITerrainPolyline != null)
            {
                ILineString cLineString = pITerrainPolyline.Geometry as ILineString;
                IPoint pIPoint = cLineString.Points[0] as IPoint;
                IPoint pIPoint1 = cLineString.Points[3] as IPoint;
                IPoint pIPoint2 = cLineString.Points[4] as IPoint;
                IPosition65 pIPosition = sgworld.Creator.CreatePosition(pIPoint.X, pIPoint.Y, pIPoint.Z, AltitudeTypeCode.ATC_ON_TERRAIN, 0, 0, 0, 0);
                IPosition65 pIPosition1 = sgworld.Creator.CreatePosition(pIPoint1.X, pIPoint1.Y, pIPoint1.Z, AltitudeTypeCode.ATC_ON_TERRAIN, 0, 0, 0, 0);
                IPosition65 pIPosition2 = sgworld.Creator.CreatePosition(pIPoint2.X, pIPoint2.Y, pIPoint2.Z, AltitudeTypeCode.ATC_ON_TERRAIN, 0, 0, 0, 0);
                IPosition65[] cVerticesArray = null;
                cVerticesArray = new IPosition65[] { pIPosition1, pIPosition2, };
                ILineOfSight65 pILineOfSight = sgworld.Analysis.CreateLineOfSight(pIPosition, 0.1, cVerticesArray, string.Empty, "tt");

                //IGeometry pIGeometry = pITerrainPolyline.Geometry;
                //pITerrainModifier = sgworld.Creator.CreateTerrainModifier(pIGeometry, ElevationBehaviorMode.EB_REPLACE, true, 0, 0, "填挖方分析");
                //pITerrainModifier.Position.Altitude = 80;
                //sgworld.Creator.DeleteObject(pITerrainPolyline.ID);
            }




        bool DrawPolygon_OnLButtonUp(int flag, int x, int y)
        {
            //如果是拖拽事件，不予增加节点
            stopTime = DateTime.Now;
            if (stopTime.Subtract(startTime) > dragSpan) return false;

            //如果是绘制事件
            IWorldPointInfo65 r_WPInfo = sgworld.Window.PixelToWorld(x, y, WorldPointType.WPT_ALL);
            r_LastPosition = r_WPInfo.Position;
            listVertices.AddRange(new double[] { r_LastPosition.X, r_LastPosition.Y, r_LastPosition.Altitude });

            if (clickTimes > 1)
            {
                listVertices.AddRange(new double[] { r_StartPosition.X, r_StartPosition.Y, r_StartPosition.Altitude });
                ILinearRing r_LinearRing = sgworld.Creator.GeometryCreator.CreateLinearRingGeometry(listVertices.ToArray());
                listVertices.RemoveRange(listVertices.Count - 4, 3);
                r_TerrainPolygon.Geometry = r_LinearRing;
                clickTimes++;
                return false;
            }

            if (clickTimes > 0)
            {
                clickTimes++;
                return false;
            }

            if (clickTimes == 0)
            {
                r_StartPosition = r_LastPosition.Copy();
                listVertices.AddRange(new double[] { r_StartPosition.X, r_StartPosition.Y, r_StartPosition.Altitude });
                r_GroupID = sgworld.ProjectTree.CreateGroup("绘制多边形");
                IColor65 r_LineColor = sgworld.Creator.CreateColor(255, 0, 0);
                IColor65 r_FillColor = sgworld.Creator.CreateColor(0, 255, 0, 0x7F); 
                r_TerrainPolyline = sgworld.Creator.CreatePolylineFromArray(
                    null, r_LineColor, AltitudeTypeCode.ATC_ON_TERRAIN, r_GroupID);
                //r_TerrainPolyline.LineStyle.Width = LineWidth;
                r_TerrainPolyline.LineStyle.Color = r_LineColor;
                r_TerrainPolygon = sgworld.Creator.CreatePolygon(
                    null, r_LineColor, r_FillColor, AltitudeTypeCode.ATC_ON_TERRAIN, r_GroupID);
                r_TerrainPolygon.LineStyle.Width = r_TerrainPolyline.LineStyle.Width;
                r_TerrainPolygon.LineStyle.Color = r_LineColor;
                listVertices.RemoveRange(listVertices.Count - 4, 3);
                clickTimes++;
                return false;
            }

            return false;
        }
        
        void DrawPolygon_OnFrame()
        {
            IMouseInfo65 r_MouseInfo = sgworld.Window.GetMouseInfo();
            IWorldPointInfo65 r_WPInfo = sgworld.Window.PixelToWorld(r_MouseInfo.X, r_MouseInfo.Y, WorldPointType.WPT_ALL);
            r_CurrentPosition = r_WPInfo.Position;

            if (clickTimes > 0)
            {
                double[] r_LineVertices = 
                { 
                    r_StartPosition.X,r_StartPosition.Y,r_StartPosition.Altitude,
                    r_LastPosition.X,r_LastPosition.Y,r_LastPosition.Altitude,
                    r_CurrentPosition.X,r_CurrentPosition.Y,r_CurrentPosition.Altitude,
                    r_StartPosition.X,r_StartPosition.Y,r_StartPosition.Altitude,
                };
                ILineString r_LineString = sgworld.Creator.GeometryCreator.CreateLineStringGeometry(r_LineVertices);
                r_TerrainPolyline.Geometry = r_LineString;
            }
        }

        bool DrawPolygon_OnRButtonUp(int flag, int x, int y)
        {
            sgworld.Window.SetInputMode(MouseInputMode.MI_FREE_FLIGHT);
            this.Enabled = true;
            if (r_TerrainPolyline != null) r_TerrainPolyline.Visibility.Show = false;
            if (r_TerrainPolygon != null) r_TerrainPolygon.Visibility.Show = false;

            if (clickTimes > 2)
            {
                //创建临时用地块
                if (m_LandPolygon == null)
                {
                    m_LandPolygon = sgworld.Creator.CreatePolygon(
                         null, 0, 0, AltitudeTypeCode.ATC_ON_TERRAIN, string.Empty, "地块");
                }
                m_LandPolygon.LineStyle.Width = r_TerrainPolygon.LineStyle.Width;
                m_LandPolygon.LineStyle.Color = r_TerrainPolygon.LineStyle.Color;
                m_LandPolygon.FillStyle.Color = r_TerrainPolygon.FillStyle.Color;

                m_LandPolygon.Geometry = r_TerrainPolygon.Geometry.Clone();

                //chkLandArea.Enabled = true;
                //chkLandArea.Checked = false;
                //nudLandArea.Value = (decimal)((IPolygon)m_LandPolygon.Geometry).Area;
                //editMode = true;
            }
            listVertices.Clear();
            sgworld.ProjectTree.DeleteItem(r_GroupID);
            clickTimes = 0;
            //btnSave.Enabled = true;

            //解除橡皮筋绘图事件
            //sgworld.OnLButtonDown -= DrawPolygon_OnLButtonDown;
            sgworld.OnRButtonUp -= DrawPolygon_OnLButtonUp;
            sgworld.OnFrame -= DrawPolygon_OnFrame;
            sgworld.OnRButtonUp -= DrawPolygon_OnRButtonUp;
            return false;
        }



